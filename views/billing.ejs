<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing - Mughal Molding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .bill-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .total-section { background: #e9ecef; padding: 15px; border-radius: 5px; font-weight: bold; }
        
        /* Print Styling */
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4 no-print">
    <div class="container">
        <a class="navbar-brand" href="/">Mughal Molding</a>
        <a href="/" class="btn btn-light btn-sm">Dashboard</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-5 no-print">
            <div class="card p-3 mb-3">
                <h5>Add Item</h5>
                <select id="product_select" class="form-select mb-2" onchange="updatePrice()">
                    <option value="" data-price="0">Select Product...</option>
                    <% products.forEach(p => { %>
                        <option value="<%= p.id %>" data-name="<%= p.item_name %>" data-price="<%= p.price %>" data-stock="<%= p.stock %>" data-feet="<%= p.feet %>">
                            <%= p.item_name %> (Stock: <%= p.stock %>)
                        </option>
                    <% }) %>
                </select>
                
                <div class="row">
                    <div class="col-6">
                        <input type="number" id="qty" class="form-control mb-2" placeholder="Quantity (Nagg)" min="1" value="1">
                    </div>
                    <div class="col-6">
                        <input type="number" id="feet" class="form-control mb-2" placeholder="Feet (Optional)">
                    </div>
                </div>
                
                <input type="number" id="custom_price" class="form-control mb-2" placeholder="Price (per item)">
                <button onclick="addItem()" class="btn btn-success w-100">Add to Bill</button>
            </div>
            
            <div class="d-grid gap-2">
                <button onclick="clearBill()" class="btn btn-warning text-white">
                    ðŸ§¹ Naya Bill (Clear)
                </button>
            </div>
        </div>

        <div class="col-md-7">
            <div id="printableArea" class="bill-container">
                <div class="text-center mb-3">
                    <h3>Mughal Molding</h3>
                    <p>Bill Receipt</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <input type="text" id="customer_name" class="form-control" placeholder="Customer Name">
                    </div>
                    <div class="col-6">
                        <input type="text" id="customer_phone" class="form-control" placeholder="Phone Number">
                    </div>
                </div>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Feet</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th class="no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="bill_items">
                        </tbody>
                </table>

                <div class="total-section">
                    <div class="d-flex justify-content-between">
                        <span>Grand Total:</span>
                        <span id="grand_total">0</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2 align-items-center">
                        <span>Advance / Paid:</span>
                        <input type="number" id="advance" class="form-control form-control-sm w-25" value="0" oninput="calculateBalance()">
                    </div>
                    <div class="d-flex justify-content-between mt-2 text-danger">
                        <span>Remaining (Udhaar):</span>
                        <span id="remaining">0</span>
                    </div>
                </div>
                
                <div class="mt-3 text-center no-print">
                    <button onclick="window.print()" class="btn btn-secondary me-2">Print Bill</button>
                    <button onclick="saveKhata()" class="btn btn-primary">Save to Khata</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];
    
    function updatePrice() {
        const select = document.getElementById('product_select');
        const price = select.options[select.selectedIndex].getAttribute('data-price');
        document.getElementById('custom_price').value = price;
    }

    function addItem() {
        const select = document.getElementById('product_select');
        const id = select.value;
        if (!id) return alert("Select a product first!");

        const name = select.options[select.selectedIndex].getAttribute('data-name');
        const qty = parseFloat(document.getElementById('qty').value) || 0;
        const feet = parseFloat(document.getElementById('feet').value) || 0;
        const price = parseFloat(document.getElementById('custom_price').value) || 0;
        
        // Total Calculation logic
        // Agar Feet dale hain to Feet * Qty * Price, warna sirf Qty * Price
        // (Aap apne hisab se logic change kar sakte hain)
        let total = 0;
        if (feet > 0) {
            total = price * feet * qty; // Example logic
        } else {
            total = price * qty;
        }

        cart.push({ id, name, qty, feet, price, total });
        renderCart();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById('bill_items');
        tbody.innerHTML = '';
        let grandTotal = 0;

        cart.forEach((item, index) => {
            grandTotal += item.total;
            tbody.innerHTML += `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.feet || '-'}</td>
                    <td>${item.price}</td>
                    <td>${item.total}</td>
                    <td class="no-print">
                        <button onclick="removeItem(${index})" class="btn btn-danger btn-sm">X</button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('grand_total').innerText = grandTotal;
        calculateBalance();
    }

    function calculateBalance() {
        const total = parseFloat(document.getElementById('grand_total').innerText) || 0;
        const advance = parseFloat(document.getElementById('advance').value) || 0;
        document.getElementById('remaining').innerText = total - advance;
    }

    // --- YE HAI WO FUNCTION JO CHANGE KIYA HAI ---
    async function saveKhata() {
        const name = document.getElementById('customer_name').value;
        const phone = document.getElementById('customer_phone').value;
        
        if (!name || cart.length === 0) return alert("Customer Name aur Items add karein!");

        const total = parseFloat(document.getElementById('grand_total').innerText);
        const advance = parseFloat(document.getElementById('advance').value);
        const remaining = parseFloat(document.getElementById('remaining').innerText);

        const data = {
            name, phone, total, advance, remaining,
            items: JSON.stringify(cart)
        };

        try {
            const res = await fetch('/save_khata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.status === 'success') {
                alert("âœ… Bill Save Ho Gaya! (Screen clear nahi hui)");
                // Maine yahan se 'clearBill()' hata diya hai.
                // Ab bill screen par hi rahega.
            } else {
                alert("Error: " + result.message);
            }
        } catch (error) {
            alert("Network Error!");
        }
    }

    // Naya button banaya hai jo manually clear karega
    function clearBill() {
        if(confirm("Kya aap waqai Naya Bill banana chahte hain? Purana data saaf ho jaye ga.")) {
            cart = [];
            document.getElementById('customer_name').value = '';
            document.getElementById('customer_phone').value = '';
            document.getElementById('advance').value = '0';
            renderCart();
        }
    }
</script>

</body>
</html>