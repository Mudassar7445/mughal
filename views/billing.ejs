<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing - Mughal Molding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .bill-header { background: #2c3e50; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .total-section { background: #e9ecef; padding: 20px; border-radius: 5px; font-weight: bold; font-size: 1.2rem; }
        /* Print ke liye khaas setting */
        @media print {
            .no-print { display: none !important; }
            .bill-header { color: black !important; background: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üßæ New Bill (Mughal Molding)</h2>
        <a href="/" class="btn btn-secondary no-print">Back to Dashboard</a>
    </div>

    <div class="row">
        <div class="col-md-5 no-print">
            <div class="card p-3 shadow-sm">
                <h4>Add Item</h4>
                
                <div class="mb-2">
                    <label>Select Product</label>
                    <select id="product_select" class="form-control" onchange="updatePrice()">
                        <option value="" data-price="0" data-feet="0">Select...</option>
                        <% products.forEach(p => { %>
                            <option value="<%= p.id %>" data-price="<%= p.price %>" data-feet="<%= p.feet %>" data-name="<%= p.item_name %>">
                                <%= p.item_name %> (Stock: <%= p.stock %>)
                            </option>
                        <% }) %>
                    </select>
                </div>

                <div class="row">
                    <div class="col-6 mb-2">
                        <label>Quantity (Nag)</label>
                        <input type="number" id="qty" class="form-control" value="1" min="1" oninput="calculateItemTotal()">
                    </div>
                    <div class="col-6 mb-2">
                        <label>Feet (Per Nag)</label>
                        <input type="number" id="feet" class="form-control" value="0" step="0.1" oninput="calculateItemTotal()">
                    </div>
                </div>

                <div class="mb-2">
                    <label>Price (Per Foot/Item)</label>
                    <input type="number" id="price" class="form-control" value="0" oninput="calculateItemTotal()">
                </div>

                <div class="mb-3">
                    <label>Total Item Price</label>
                    <input type="text" id="item_total" class="form-control" readonly>
                </div>

                <button class="btn btn-primary w-100" onclick="addItem()">Add to Bill ‚¨áÔ∏è</button>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card p-3 shadow-sm">
                <div class="row mb-3">
                    <div class="col-6">
                        <input type="text" id="c_name" class="form-control" placeholder="Customer Name">
                    </div>
                    <div class="col-6">
                        <input type="number" id="c_phone" class="form-control" placeholder="Phone Number">
                    </div>
                </div>

                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Feet</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th class="no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="bill_body">
                        </tbody>
                </table>

                <div class="total-section">
                    <div class="d-flex justify-content-between">
                        <span>Grand Total:</span>
                        <span id="grand_total">0</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span>Advance / Paid:</span>
                        <input type="number" id="advance" class="form-control w-25 no-print" value="0" oninput="updateBalance()">
                        <span class="d-none d-print-block" id="print_advance">0</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2 text-danger">
                        <span>Remaining (Udhaar):</span>
                        <span id="remaining">0</span>
                    </div>
                </div>

                <div class="mt-3 no-print d-flex gap-2">
                    <button class="btn btn-success flex-grow-1" id="saveBtn" onclick="saveBill()">üíæ Save to Khata</button>
                    <button class="btn btn-dark" onclick="window.print()">üñ®Ô∏è Print</button>
                    <button class="btn btn-warning" onclick="clearBill()">üîÑ New Bill / Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];

    function updatePrice() {
        const select = document.getElementById("product_select");
        const option = select.options[select.selectedIndex];
        document.getElementById("price").value = option.getAttribute("data-price");
        document.getElementById("feet").value = option.getAttribute("data-feet");
        calculateItemTotal();
    }

    function calculateItemTotal() {
        const qty = parseFloat(document.getElementById("qty").value) || 0;
        const feet = parseFloat(document.getElementById("feet").value) || 0;
        const price = parseFloat(document.getElementById("price").value) || 0;
        
        // Agar feet hain to (Qty * Feet * Price), warna seedha (Qty * Price)
        let total = 0;
        if (feet > 0) {
            total = qty * feet * price;
        } else {
            total = qty * price;
        }
        document.getElementById("item_total").value = Math.round(total);
    }

    function addItem() {
        const select = document.getElementById("product_select");
        const id = select.value;
        const name = select.options[select.selectedIndex].getAttribute("data-name");
        const qty = parseFloat(document.getElementById("qty").value);
        const feet = parseFloat(document.getElementById("feet").value);
        const price = parseFloat(document.getElementById("price").value);
        const total = parseFloat(document.getElementById("item_total").value);

        if (!id) return alert("Product select karein!");

        cart.push({ id, name, qty, feet, price, total });
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById("bill_body");
        tbody.innerHTML = "";
        let grandTotal = 0;

        cart.forEach((item, index) => {
            grandTotal += item.total;
            tbody.innerHTML += `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.feet > 0 ? item.feet : '-'}</td>
                    <td>${item.price}</td>
                    <td>${item.total}</td>
                    <td class="no-print"><button class="btn btn-sm btn-danger" onclick="removeItem(${index})">X</button></td>
                </tr>
            `;
        });

        document.getElementById("grand_total").innerText = grandTotal;
        updateBalance();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function updateBalance() {
        const total = parseFloat(document.getElementById("grand_total").innerText);
        const advance = parseFloat(document.getElementById("advance").value) || 0;
        document.getElementById("remaining").innerText = total - advance;
        
        // Print ke liye advance update
        document.getElementById("print_advance").innerText = advance;
    }

    // --- MAIN FUNCTION JIS MEIN CHANGE KIYA HAI ---
    async function saveBill() {
        const name = document.getElementById("c_name").value;
        const phone = document.getElementById("c_phone").value;
        const total = document.getElementById("grand_total").innerText;
        const advance = document.getElementById("advance").value;
        const remaining = document.getElementById("remaining").innerText;

        if (!name || cart.length === 0) return alert("Naam aur Items zaroori hain!");

        document.getElementById("saveBtn").innerText = "Saving...";
        document.getElementById("saveBtn").disabled = true;

        try {
            const res = await fetch('/save_khata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, total, advance, remaining, items: JSON.stringify(cart) })
            });
            const result = await res.json();
            
            if (result.status === "success") {
                alert("‚úÖ Bill Save Ho Gaya!");
                // YAHAN SE 'RELOAD' HATA DIYA HAI.
                document.getElementById("saveBtn").innerText = "Saved ‚úÖ";
                // Ab bill screen par hi rahega jab tak aap 'New Bill' nahi dabate.
            } else {
                alert("Error: " + result.message);
                document.getElementById("saveBtn").disabled = false;
                document.getElementById("saveBtn").innerText = "üíæ Save to Khata";
            }
        } catch (e) {
            alert("Error saving bill");
            document.getElementById("saveBtn").disabled = false;
        }
    }

    function clearBill() {
        if(confirm("Screen saaf karni hai? Data save nahi hua to zaya ho jaye ga!")) {
            window.location.reload();
        }
    }
</script>

</body>
</html>